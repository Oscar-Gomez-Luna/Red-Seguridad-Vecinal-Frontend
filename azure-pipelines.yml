trigger:
- master

pool:
  name: 'AgenteLocal'
  demands:
    - agent.name -equals LAPTOP-GLDNITHE

variables:
- group: SWA-Deployment-Secrets

jobs:
- job: BuildAndDeploy
  displayName: "Build and Deploy"
  steps:

  - checkout: self
    displayName: "Checkout code"

  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: "Install Node.js"

  - powershell: |
      node --version
      npm --version
      Get-ChildItem package*.json -ErrorAction SilentlyContinue
    displayName: "Show versions and check package files"

  - script: npm install
    displayName: "Install dependencies"
    env:
      CI: true

  - script: npm run build
    displayName: "Build"
    env:
      CI: true
      NODE_ENV: production

  - powershell: |
      Get-ChildItem dist -Recurse -ErrorAction SilentlyContinue | Select-Object -First 10 Name
    displayName: "Verify dist content"

  - task: AzureStaticWebApp@0
    inputs:
      app_location: '/'
      output_location: 'dist'
      azure_static_web_apps_api_token: $(SWA_DEPLOYMENT_TOKEN)
      skip_app_build: true
    displayName: "Deploy to SWA"