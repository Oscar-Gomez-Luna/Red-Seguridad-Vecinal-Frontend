trigger:
- master

pool:
  name: 'AgenteLocal'
  demands:
    - agent.name -equals LAPTOP-GLDNITHE

variables:
  app_location: "/"
  api_location: ""
  output_location: "dist"
  # Token guardado como variable secreta en Azure DevOps
  swa_token: "$(STATIC_WEB_APPS_TOKEN)"

stages:
- stage: Build
  displayName: "Build Stage"
  jobs:
  - job: BuildJob
    displayName: "Compilar con Yarn y Vite"
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: "Instalar Node.js"

    - script: yarn install --frozen-lockfile
      displayName: "Instalar dependencias"

    - script: yarn build
      displayName: "Compilar proyecto"

    - script: |
        echo "--- DIAGNOSTICO ---"
        dir
        dir dist
      displayName: "Diagn√≥stico de carpeta dist"
      continueOnError: true

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: "dist"
        ArtifactName: "dist"
        publishLocation: "Container"
      displayName: "Publicar artefactos"

- stage: Deploy
  displayName: "Deploy Stage"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployJob
    displayName: "Desplegar a Static Web Apps"
    steps:

    - download: current
      artifact: dist

    - task: AzureStaticWebApp@0
      displayName: "Deploy to Azure Static Web App con Deployment Token"
      inputs:
        app_location: "$(app_location)"
        api_location: "$(api_location)"
        output_location: "$(output_location)"
        azure_static_web_apps_api_token: "$(swa_token)"
