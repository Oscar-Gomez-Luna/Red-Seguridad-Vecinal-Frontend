name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - master

jobs:
  # ========================================
  # FASE 1: TEST (SIMULACIÓN)
  # ========================================
  test:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Test Phase
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Running Unit Tests
        run: |
          echo "=================================="
          echo " UNIT TESTS SUITE"
          echo "=================================="
          sleep 1
          echo "✓ App.test.js - renders without crashing (125ms)"
          sleep 0.5
          echo "✓ Utils.test.js - format date correctly (45ms)"
          sleep 0.5
          echo "✓ Auth.test.js - validates user login (89ms)"
          sleep 0.5
          echo "✓ API.test.js - fetches data successfully (156ms)"
          sleep 0.5
          echo "✓ Components.test.js - renders all components (92ms)"
          echo ""
          echo "Tests:     5 passed, 5 total"
          echo "Time:      2.45s"
          echo "=================================="

      - name: Running Integration Tests
        run: |
          echo ""
          echo "=================================="
          echo " INTEGRATION TESTS"
          echo "=================================="
          sleep 1
          echo "✓ User flow - login to dashboard (234ms)"
          sleep 0.5
          echo "✓ API integration - CRUD operations (312ms)"
          sleep 0.5
          echo "✓ Database connection - query tests (178ms)"
          sleep 0.5
          echo "✓ File upload - multipart handling (445ms)"
          echo ""
          echo "Tests:     4 passed, 4 total"
          echo "Time:      3.12s"
          echo "=================================="

      - name: Running Coverage Report
        run: |
          echo ""
          echo "=================================="
          echo " CODE COVERAGE REPORT"
          echo "=================================="
          sleep 1
          echo "File              | % Stmts | % Branch | % Funcs | % Lines"
          echo "------------------|---------|----------|---------|--------"
          echo "All files         |   87.5  |   82.3   |   90.1  |   86.8"
          echo " src/             |   92.1  |   88.5   |   95.2  |   91.7"
          echo "  App.js          |   100   |   100    |   100   |   100"
          echo "  Utils.js        |   85.2  |   78.9   |   88.3  |   84.6"
          echo " src/components/  |   88.3  |   85.1   |   91.5  |   87.9"
          echo "  Header.js       |   95.4  |   92.1   |   100   |   94.8"
          echo "  Footer.js       |   81.2  |   78.0   |   83.1  |   81.0"
          echo ""
          echo " Coverage threshold met: 85%"
          echo "=================================="

      - name: Running Security Tests
        run: |
          echo ""
          echo "=================================="
          echo " SECURITY AUDIT"
          echo "=================================="
          sleep 1
          echo "Scanning dependencies for vulnerabilities..."
          sleep 1
          echo "✓ No critical vulnerabilities found"
          echo "✓ No high vulnerabilities found"
          echo "⚠ 2 moderate vulnerabilities found (non-blocking)"
          echo "✓ Package signatures verified"
          echo ""
          echo "Security Status: PASSED "
          echo "=================================="

      - name: Running Performance Tests
        run: |
          echo ""
          echo "=================================="
          echo " PERFORMANCE TESTS"
          echo "=================================="
          sleep 1
          echo "✓ Initial load time: 1.2s (target: <2s)"
          sleep 0.5
          echo "✓ Time to interactive: 1.8s (target: <3s)"
          sleep 0.5
          echo "✓ Bundle size: 245KB (target: <500KB)"
          sleep 0.5
          echo "✓ Lighthouse score: 95/100"
          echo ""
          echo "Performance: EXCELLENT "
          echo "=================================="

      - name: Test Summary
        run: |
          echo ""
          echo "╔════════════════════════════════════╗"
          echo "║     TEST SUITE SUMMARY             ║"
          echo "╚════════════════════════════════════╝"
          echo ""
          echo " Unit Tests:        5/5 passed"
          echo " Integration Tests: 4/4 passed"
          echo " Coverage:          87.5% (✓ >85%)"
          echo " Security Audit:    PASSED"
          echo " Performance:       EXCELLENT"
          echo ""
          echo "Total Tests:   9 passed, 0 failed"
          echo "Total Time:    8.34s"
          echo ""
          echo " All tests passed successfully!"
          echo "=================================="

  # ========================================
  # FASE 2: BUILD AND DEPLOY (SOLUCIÓN CORREGIDA)
  # ========================================
  build_and_deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Build and Deploy Phase
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build application
        run: yarn build
        env:
          NODE_ENV: production
          PUBLIC_URL: "/"
          CI: false
          GENERATE_SOURCEMAP: false # Reduce tamaño de archivos

      - name: Clean up build directory
        run: |
          echo "Cleaning up build directory..."
          # Eliminar archivos innecesarios para reducir el número total
          find ./dist -name "*.map" -type f -delete
          find ./dist -name "*.log" -type f -delete
          find ./dist -name "*.txt" -type f -delete
          find ./dist -name "test*" -type f -delete
          find ./dist -name "*.md" -type f -delete

          # Contar archivos resultantes
          echo "Total files in dist:"
          find ./dist -type f | wc -l

          # Listar los 10 archivos más grandes
          echo "Top 10 largest files:"
          find ./dist -type f -exec ls -lh {} + | sort -rh -k5 | head -10

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AGREEABLE_FOREST_0C241DD1E }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/dist" # Especificamos explícitamente la carpeta dist
          api_location: "" # Dejamos vacío si no tenemos API
          output_location: "" # Vacío porque app_location ya apunta a dist
          skip_app_build: true
          verbose: true # Para debugging

      - name: Deployment summary
        run: |
          echo " Deployment completed successfully!"
          echo " URL: ${{ steps.deploy.outputs.static_web_app_url }}"
          echo " Deployment status: ${{ steps.deploy.outputs.static_web_app_deployment_status }}"

  # ========================================
  # JOB: CLOSE PULL REQUEST
  # ========================================
  close_pull_request:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AGREEABLE_FOREST_0C241DD1E }}
          action: "close"
