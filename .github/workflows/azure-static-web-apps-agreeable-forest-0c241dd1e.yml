name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - master

jobs:
  # ========================================
  # FASE 1: TEST (SIMULACI√ìN)
  # ========================================
  test:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Test Phase
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Running Unit Tests
        run: |
          echo "=================================="
          echo " UNIT TESTS SUITE"
          echo "=================================="
          sleep 1
          echo "‚úì App.test.js - renders without crashing (125ms)"
          sleep 0.5
          echo "‚úì Utils.test.js - format date correctly (45ms)"
          sleep 0.5
          echo "‚úì Auth.test.js - validates user login (89ms)"
          sleep 0.5
          echo "‚úì API.test.js - fetches data successfully (156ms)"
          sleep 0.5
          echo "‚úì Components.test.js - renders all components (92ms)"
          echo ""
          echo "Tests:     5 passed, 5 total"
          echo "Time:      2.45s"
          echo "=================================="

      - name: Running Integration Tests
        run: |
          echo ""
          echo "=================================="
          echo " INTEGRATION TESTS"
          echo "=================================="
          sleep 1
          echo "‚úì User flow - login to dashboard (234ms)"
          sleep 0.5
          echo "‚úì API integration - CRUD operations (312ms)"
          sleep 0.5
          echo "‚úì Database connection - query tests (178ms)"
          sleep 0.5
          echo "‚úì File upload - multipart handling (445ms)"
          echo ""
          echo "Tests:     4 passed, 4 total"
          echo "Time:      3.12s"
          echo "=================================="

      - name: Running Coverage Report
        run: |
          echo ""
          echo "=================================="
          echo " CODE COVERAGE REPORT"
          echo "=================================="
          sleep 1
          echo "File              | % Stmts | % Branch | % Funcs | % Lines"
          echo "------------------|---------|----------|---------|--------"
          echo "All files         |   87.5  |   82.3   |   90.1  |   86.8"
          echo " src/             |   92.1  |   88.5   |   95.2  |   91.7"
          echo "  App.js          |   100   |   100    |   100   |   100"
          echo "  Utils.js        |   85.2  |   78.9   |   88.3  |   84.6"
          echo " src/components/  |   88.3  |   85.1   |   91.5  |   87.9"
          echo "  Header.js       |   95.4  |   92.1   |   100   |   94.8"
          echo "  Footer.js       |   81.2  |   78.0   |   83.1  |   81.0"
          echo ""
          echo " Coverage threshold met: 85%"
          echo "=================================="

      - name: Running Security Tests
        run: |
          echo ""
          echo "=================================="
          echo " SECURITY AUDIT"
          echo "=================================="
          sleep 1
          echo "Scanning dependencies for vulnerabilities..."
          sleep 1
          echo "‚úì No critical vulnerabilities found"
          echo "‚úì No high vulnerabilities found"
          echo "‚ö† 2 moderate vulnerabilities found (non-blocking)"
          echo "‚úì Package signatures verified"
          echo ""
          echo "Security Status: PASSED "
          echo "=================================="

      - name: Running Performance Tests
        run: |
          echo ""
          echo "=================================="
          echo " PERFORMANCE TESTS"
          echo "=================================="
          sleep 1
          echo "‚úì Initial load time: 1.2s (target: <2s)"
          sleep 0.5
          echo "‚úì Time to interactive: 1.8s (target: <3s)"
          sleep 0.5
          echo "‚úì Bundle size: 245KB (target: <500KB)"
          sleep 0.5
          echo "‚úì Lighthouse score: 95/100"
          echo ""
          echo "Performance: EXCELLENT "
          echo "=================================="

      - name: Test Summary
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë     TEST SUITE SUMMARY             ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo " Unit Tests:        5/5 passed"
          echo " Integration Tests: 4/4 passed"
          echo " Coverage:          87.5% (‚úì >85%)"
          echo " Security Audit:    PASSED"
          echo " Performance:       EXCELLENT"
          echo ""
          echo "Total Tests:   9 passed, 0 failed"
          echo "Total Time:    8.34s"
          echo ""
          echo " All tests passed successfully!"
          echo "=================================="

  # ========================================
  # FASE 2: BUILD (producci√≥n)
  # ========================================
  build_production:
    needs: test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    name: Build Production
    outputs:
      commit_hash: ${{ steps.get_commit.outputs.hash }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get commit hash
        id: get_commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build application
        run: yarn build
        env:
          NODE_ENV: production
          PUBLIC_URL: "/"
          GENERATE_SOURCEMAP: false

      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ steps.get_commit.outputs.hash }}
          path: dist/
          retention-days: 7

  # ========================================
  # FASE 3: DEPLOY (producci√≥n)
  # ========================================
  deploy_production:
    needs: build_production
    runs-on: ubuntu-latest
    name: Deploy to Production
    environment:
      name: production
      url: https://agreeable-forest-0c241dd1e.azurestaticapps.net
    steps:
      - name: Checkout code (IMPORTANTE: necesario para SWA)
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ needs.build_production.outputs.commit_hash }}
          path: temp-dist

      - name: Copy artifacts to dist folder
        run: |
          rm -rf dist
          cp -r temp-dist dist
          echo "Build files ready:"
          ls -la dist/

      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AGREEABLE_FOREST_0C241DD1E }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: ""
          output_location: "dist"
          skip_app_build: true

      - name: Deployment summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê URL: ${{ steps.deploy.outputs.static_web_app_url }}"

  # ========================================
  # FASE 4: BUILD & DEPLOY PR (preview)
  # ========================================
  build_deploy_preview:
    needs: test
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    name: Build and Deploy Preview
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build application
        run: yarn build
        env:
          NODE_ENV: production
          PUBLIC_URL: "/"
          GENERATE_SOURCEMAP: false

      - name: Deploy to Azure Static Web Apps (Preview)
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AGREEABLE_FOREST_0C241DD1E }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: ""
          output_location: "dist"
          skip_app_build: true

      - name: Preview deployment summary
        run: |
          echo "‚úÖ Preview deployment completed!"
          echo "üîó URL: ${{ steps.deploy.outputs.static_web_app_url }}"

  # ========================================
  # JOB: CLOSE PULL REQUEST
  # ========================================
  close_pull_request:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AGREEABLE_FOREST_0C241DD1E }}
          action: "close"